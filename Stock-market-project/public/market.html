<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MCM Stocks — Market</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./main.css" />
  <link href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <script src="./main.js"></script>

  <style>
    :root { --ok:#16c784; --bad:#ea3943; }
    .market-wrap { display:grid; grid-template-columns: 1fr 360px; gap:16px; }
    @media (max-width: 1100px){ .market-wrap { grid-template-columns: 1fr; } }
    .tools { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .input, .select { padding:10px; border:1px solid var(--gray); border-radius:6px; background:#fff; }
    .btn { padding:9px 12px; border-radius:6px; border:1px solid var(--gray); background:#fff; cursor:pointer; }
    .btn.primary { background: var(--navy); color:#fff; border-color: var(--navy); }
    .btn.ghost { background:#fff; }
    .btn.buy { background: var(--ok); color:#fff; border-color: var(--ok); }
    .btn.sell { background: var(--bad); color:#fff; border-color: var(--bad); }
    .tbl td:last-child, .tbl th:last-child { text-align:right; }
    .drawer { position: sticky; top: 16px; background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:14px; box-shadow: 0 4px 16px rgba(0,0,0,.06); min-height: 240px; }
    .drawer .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap:6px 10px; margin-top:10px; }
    .chart { width:100%; height:180px; border:1px solid #eee; border-radius:8px; margin-top:12px; background: linear-gradient(180deg,#fafafa, #fff); }
    .pad { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
    .field label { font-size:12px; font-weight:700; display:block; margin-bottom:6px; }
    .field input, .field select { width:100%; padding:9px; border:1px solid #ccc; border-radius:6px; background:#fff; }
    .pager { display:flex; gap:8px; justify-content:flex-end; align-items:center; padding:8px; }
    .pager .page { padding:6px 10px; border:1px solid #ddd; border-radius:6px; cursor:pointer; }
    .pager .active { background:#111; color:#fff; border-color:#111; }
  </style>
</head>
<body>

<header>
  <div style="font-weight:700">MCM Stocks</div>
  <nav>
    <ul>
      <li><a href="index.html" data-top="index.html">Home</a></li>
      <li><a href="cash.html" data-top="cash.html">Wallet</a></li>
      <li><a href="market.html" data-top="market.html" class="active">Market</a></li>
      <li id="nav-login"><a href="login.html" data-top="login.html">Login</a></li>
      <li id="nav-register"><a href="register.html" data-top="register.html">Register</a></li>
      <li id="nav-logout" style="display:none;"><a href="#" onclick="logoutUser()">Logout</a></li>
    </ul>
  </nav>
</header>

<main class="content">
  <h2 style="margin:8px 0 14px;">Market</h2>

  <div class="card tools" style="margin-bottom:12px;">
    <input id="q" class="input" placeholder="Search by ticker or name…" style="flex:1; min-width:240px;">
    <select id="fExchange" class="select">
      <option value="">Exchange</option><option>NASDAQ</option><option>NYSE</option><option>AMEX</option>
    </select>
    <select id="fSector" class="select">
      <option value="">Sector</option>
      <option>Technology</option><option>Financials</option><option>Healthcare</option>
      <option>Energy</option><option>Industrials</option><option>Consumer Discretionary</option>
      <option>Consumer Staples</option><option>Utilities</option><option>Materials</option><option>Real Estate</option><option>Communication Services</option>
    </select>
    <select id="sortBy" class="select">
      <option value="ticker">Sort: Ticker</option>
      <option value="name">Sort: Name</option>
      <option value="price">Sort: Price</option>
    </select>
    <button id="btnApply" class="btn">Apply</button>
    <button id="btnReset" class="btn">Reset</button>
  </div>

  <div class="market-wrap">
    <section class="card" style="overflow:auto;">
      <table class="tbl" style="margin:0;">
        <thead>
          <tr>
            <th style="width:110px;">Ticker</th>
            <th>Name</th>
            <th style="width:120px;">Exchange</th>
            <th style="width:160px;">Sector</th>
            <th style="width:90px;">Price</th>
            <th style="width:120px; text-align:right;">Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6">Loading…</td></tr>
        </tbody>
      </table>
      <div class="pager" id="pager" style="border-top:1px solid #eee;"></div>
    </section>

    <aside class="drawer" id="drawer">
      <div class="row">
        <div>
          <h3 id="dSym">—</h3>
          <div id="dName" class="muted">Select a symbol</div>
        </div>
        <div style="text-align:right">
          <div id="dPrice" style="font-weight:700; font-size:20px;">$—</div>
          <div id="dChange" class="muted">0.00%</div>
        </div>
      </div>

      <canvas id="dChart" class="chart" width="320" height="180" aria-label="Candles"></canvas>

      <div class="kv">
        <div class="muted">Exchange</div><div id="dEx">—</div>
        <div class="muted">Sector</div><div id="dSec">—</div>
        <div class="muted">Currency</div><div id="dCur">—</div>
        <div class="muted">Total Shares</div><div id="dShares">—</div>
      </div>

      <div class="pad">
        <div class="field">
          <label for="side">Side</label>
          <select id="side">
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
        </div>
        <div class="field">
          <label for="qty">Quantity</label>
          <input id="qty" type="number" min="1" step="1" value="1" />
        </div>
        <button id="btnQuickOrder" class="btn primary" style="grid-column:1/-1">
          <i class="fa fa-bolt"></i> Place Quick Order
        </button>
        <button id="btnOpenTrade" class="btn ghost" style="grid-column:1/-1">
          <i class="fa fa-line-chart"></i> Open Trade Ticket
        </button>
      </div>
    </aside>
  </div>
</main>

<footer class="content" style="padding:20px 0 28px;">
  <p class="muted">© 2025 MCM Stocks</p>
</footer>

<script>
  const $ = (s, el=document)=>el.querySelector(s);
  const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const formatPrice = n => '$' + Number(n ?? 0).toFixed(2);
  const fmtInt = n => Number(n ?? 0).toLocaleString();

  function getUserId() {
    try {
      const id = localStorage.getItem('auth.id');
      return id ? String(id) : null;
    } catch(_) { return null; }
  }

  async function httpJson(url, opts={}) {
    // Use authenticated fetch when available
    if (window.AuthAPI?.fetch) {
      const r = await AuthAPI.fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
      return r.data ?? {};
    }
    const r = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
    return r.json();
  }

  // ========= State =========
  let all = [];
  let page = 1;
  let pageSize = 12;
  let selected = null;

  // ========= Load list =========
  async function loadList() {
    $('#rows').innerHTML = `<tr><td colspan="6">Loading…</td></tr>`;
    const q = $('#q').value.trim();
    const url = '/api/market/assets?limit=500' + (q ? '&q=' + encodeURIComponent(q) : '');
    const res = await httpJson(url);
    all = res?.data || [];
    renderTable();
  }

  function applyFilters(arr) {
    const ex = $('#fExchange').value;
    const sec = $('#fSector').value;
    let out = arr.filter(r => (!ex || r.exchange === ex) && (!sec || r.sector === sec));
    const sortBy = $('#sortBy').value;
    out.sort((a,b) => {
      if (sortBy === 'name') return (a.name||'').localeCompare(b.name||'');
      if (sortBy === 'price') return Number(a.initial_price||0) - Number(b.initial_price||0);
      return (a.ticker||'').localeCompare(b.ticker||'');
    });
    return out;
  }

  function renderTable() {
    const rows = $('#rows');
    const data = applyFilters(all);
    const totalPages = Math.max(1, Math.ceil(data.length / pageSize));
    page = Math.min(page, totalPages);

    const start = (page-1)*pageSize;
    const view = data.slice(start, start + pageSize);

    if (!view.length) {
      rows.innerHTML = `<tr><td colspan="6" class="muted">No symbols found.</td></tr>`;
    } else {
      rows.innerHTML = view.map(r => `
        <tr>
          <td><strong>${r.ticker}</strong></td>
          <td>${r.name}</td>
          <td>${r.exchange || '-'}</td>
          <td>${r.sector || '-'}</td>
          <td>${formatPrice(r.initial_price)}</td>
          <td>
            <div style="display:flex; gap:6px; justify-content:flex-end;">
              <button class="btn" data-act="details" data-symbol="${r.ticker}"><i class="fa fa-info-circle"></i></button>
              <button class="btn buy" data-act="buy" data-symbol="${r.ticker}"><i class="fa fa-arrow-up"></i></button>
              <button class="btn sell" data-act="sell" data-symbol="${r.ticker}"><i class="fa fa-arrow-down"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    rows.querySelectorAll('button[data-act]').forEach(b => b.addEventListener('click', onRowButton));

    const pager = $('#pager'); pager.innerHTML = '';
    for (let i=1;i<=totalPages;i++) {
      const a = document.createElement('button');
      a.className = 'page' + (i===page ? ' active':'' );
      a.textContent = i;
      a.addEventListener('click', ()=>{ page=i; renderTable(); window.scrollTo({top:0, behavior:'smooth'}); });
      pager.appendChild(a);
    }

    if (!selected && view[0]) selectSymbol(view[0]);
  }

  // ========= Drawer =========
  function selectSymbol(r) {
    selected = r;
    $('#dSym').textContent = r.ticker;
    $('#dName').textContent = r.name || '';
    $('#dPrice').textContent = formatPrice(r.initial_price);
    $('#dChange').textContent = '0.00%';
    $('#dEx').textContent = r.exchange || '-';
    $('#dSec').textContent = r.sector || '-';
    $('#dCur').textContent = r.currency || '-';
    $('#dShares').textContent = fmtInt(r.total_shares);
    drawCandles('dChart', Number(r.initial_price||0));
  }

  async function onRowButton(e) {
    const btn = e.currentTarget;
    const sym = btn.getAttribute('data-symbol');
    const act = btn.getAttribute('data-act');
    const r = all.find(x => x.ticker === sym);
    if (!r) return;

    if (act === 'details') return selectSymbol(r);
    if (act === 'buy' || act === 'sell') {
      selected = r;
      $('#side').value = act;
      $('#qty').value = 1;
      placeQuickOrder();
    }
  }

  // ========= Quick order (also adjusts cash) =========
  async function placeQuickOrder() {
    const u = getUserId();
    if (!u) { alert('Please login first.'); location.href='login.html'; return; }
    if (!selected) { alert('Select a symbol first.'); return; }

    const side = $('#side').value;
    const qty  = Math.max(1, parseInt($('#qty').value||'1',10));

    try {
      const payload = await httpJson('/api/orders/place', {
        method:'POST',
        body: JSON.stringify({ userId: String(u), symbol: selected.ticker, side, quantity: qty })
      });

      if (payload?.order_id || payload?.id || payload?.symbol_id || payload?.account_id || payload?.success) {
        // Adjust cash: withdraw on buy, deposit on sell
        const tradeAmount = Number(selected.initial_price || 0) * qty;
        if (tradeAmount > 0) {
          if (side === 'buy') {
            await AuthAPI.fetch('/api/accounts/users/withdraw', { method:'POST', body: JSON.stringify({ amount: tradeAmount, reason: 'BUY '+selected.ticker }) });
          } else {
            await AuthAPI.fetch('/api/accounts/users/deposit',  { method:'POST', body: JSON.stringify({ amount: tradeAmount, reason: 'SELL '+selected.ticker }) });
          }
          // refresh cached balance for all pages
          await AuthAPI.fetchBalanceLive();
        }
        alert(`Order accepted: ${side.toUpperCase()} ${qty} ${selected.ticker}`);
      } else if (payload?.message) {
        alert(payload.message);
      } else {
        alert('Order response: ' + JSON.stringify(payload));
      }
    } catch (err) {
      alert('Order failed: ' + err.message);
    }
  }

  $('#btnQuickOrder').addEventListener('click', placeQuickOrder);
  $('#btnOpenTrade').addEventListener('click', () => {
    if (!selected) return alert('Select a symbol first.');
    location.href = `market.html?symbol=${encodeURIComponent(selected.ticker)}`;
  });

  // Filters
  $('#btnApply').addEventListener('click', ()=>{ page=1; renderTable(); });
  $('#btnReset').addEventListener('click', ()=>{ $('#q').value=''; $('#fExchange').value=''; $('#fSector').value=''; $('#sortBy').value='ticker'; page=1; renderTable(); });
  $('#q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ page=1; loadList(); } });

  // Synthetic candles
  function drawCandles(canvasId, base) {
    const c = document.getElementById(canvasId);
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const N = 30; let last = base || 100; const data = [];
    for (let i=0;i<N;i++){
      const drift = (Math.random()-0.5)*0.8;
      const open = last; const close = Math.max(0.01, open + drift);
      const high = Math.max(open, close) + Math.random()*0.6;
      const low  = Math.min(open, close) - Math.random()*0.6;
      data.push({o:open, h:high, l:low, c:close}); last = close;
    }
    const pad = 8, w = c.width, h = c.height;
    const min = Math.min(...data.map(d=>d.l)); const max = Math.max(...data.map(d=>d.h));
    const y = v => h - pad - ((v-min)/(max-min||1))*(h-2*pad); const xw = (w-2*pad)/N;
    ctx.lineWidth = 1;
    data.forEach((d,i)=>{
      const cx = pad + i*xw + xw/2;
      ctx.strokeStyle = '#999'; ctx.beginPath(); ctx.moveTo(cx, y(d.h)); ctx.lineTo(cx, y(d.l)); ctx.stroke();
      const up = d.c >= d.o;
      ctx.fillStyle = up ? getComputedStyle(document.documentElement).getPropertyValue('--ok') || '#16c784'
                         : getComputedStyle(document.documentElement).getPropertyValue('--bad') || '#ea3943';
      const top = y(Math.max(d.o,d.c)); const bot = y(Math.min(d.o,d.c)); const bw = Math.max(3,xw*0.55);
      ctx.fillRect(cx-bw/2, top, bw, Math.max(1, bot-top));
    });
  }

  // Init
  document.addEventListener('DOMContentLoaded', async ()=>{
    const loggedIn = !!(window.AuthAPI && AuthAPI.isAuthenticated && AuthAPI.isAuthenticated());
    const logoutItem = document.getElementById("nav-logout");
    const loginItem  = document.getElementById("nav-login");
    const regItem    = document.getElementById("nav-register");
    if (loggedIn) { if (logoutItem) logoutItem.style.display='inline-block'; if (loginItem) loginItem.style.display='none'; if (regItem) regItem.style.display='none';
    } else { if (logoutItem) logoutItem.style.display='none'; if (loginItem) loginItem.style.display='inline-block'; if (regItem) regItem.style.display='inline-block'; }

    await loadList();
  });
</script>
</body>
</html>
