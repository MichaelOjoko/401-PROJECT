<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
  />
  <title>Stock App — Login & Register</title>

  <!-- Fonts / Icons (optional) -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet" />
  <link href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />

  <!-- Vue 3 (CDN) -->
  <script src="https://unpkg.com/vue@3.2.34/dist/vue.global.js"></script>

  <!-- Your global styles -->
  <link rel="stylesheet" href="./main.css" />

  <!-- Auth helper (must define AuthAPI.*) -->
  <script src="main.js"></script>
</head>
<body>
  <div id="app">
    <!-- Header / Nav -->
    <header>
      <div style="font-weight:700">MCM Stocks</div>
      <nav>
        <ul>
          <li v-for="item in menu"
              :key="item.id"
              :class="{ active: page === item.id }"
              @click="changePage(item.id)">
            {{ item.caption }}
          </li>
          <li v-if="!hasToken" :class="{ active: page === 'login' }" @click="changePage('login')">Login</li>
          <li v-if="!hasToken" :class="{ active: page === 'register' }" @click="changePage('register')">Register</li>
          <li v-if="hasToken" @click="logout">Logout</li>
        </ul>
      </nav>
    </header>

    <main>
      <!-- LOGIN PAGE -->
      <section id="login" v-if="page === 'login'">
        <div class="content auth card">
          <h1>Login</h1>

          <label>Email</label>
          <input v-model.trim="loginForm.email" type="email" placeholder="you@example.com" required>

          <label>Password</label>
          <input v-model="loginForm.password" type="password" placeholder="Password" required>

          <button class="button positive" :disabled="authLoading" @click="doLogin" style="margin-top:12px">
            <i class="fa" :class="authLoading ? 'fa-spinner' : 'fa-sign-in'"></i>
            {{ authLoading ? 'Logging in…' : 'Login' }}
          </button>

          <p class="muted" style="margin-top:10px">No account?
            <a href="#" @click.prevent="changePage('register')">Register</a>
          </p>

          <p v-if="authError" class="error">{{ authError }}</p>
        </div>
      </section>

      <!-- REGISTER PAGE -->
      <section id="register" v-if="page === 'register'">
        <div class="content auth card">
          <h1>Register</h1>

          <label>Full Name</label>
          <input v-model.trim="regForm.fullName" type="text" required>

          <label>Email</label>
          <input v-model.trim="regForm.email" type="email" required>

          <label>Password</label>
          <input v-model="regForm.password" type="password" required>

          <label>Confirm Password</label>
          <input v-model="regForm.confirm" type="password" required>

          <button class="button positive" :disabled="authLoading" @click="doRegister" style="margin-top:12px">
            <i class="fa" :class="authLoading ? 'fa-spinner' : 'fa-user-plus'"></i>
            {{ authLoading ? 'Creating…' : 'Create Account' }}
          </button>

          <p class="muted" style="margin-top:10px">Already have an account?
            <a href="#" @click.prevent="changePage('login')">Login</a>
          </p>

          <p v-if="authError" class="error">{{ authError }}</p>
        </div>
      </section>

      <!-- HOME (POST-LOGIN) -->
      <section id="home" v-if="page === 'home'">
        <div class="content">
          <div class="card">
            <h1>Welcome<span v-if="profileName">, {{ profileName }}</span>!</h1>
            <p class="muted">You are logged in. This is your starting dashboard. Replace this with your User Hub / Portfolio.</p>
            <div style="margin-top:12px">
              <button class="button" @click="goTo('trade')"><i class="fa fa-line-chart"></i> Go to Trade</button>
              <button class="button" @click="goTo('cash')" style="margin-left:8px"><i class="fa fa-money"></i> Go to Cash</button>
            </div>
          </div>
        </div>
      </section>

      <!-- PLACEHOLDER PAGES -->
      <section id="trade" v-if="page === 'trade'">
        <div class="content">
          <div class="card">
            <h2>Trade</h2>
            <p class="muted">Placeholder. Build your Trade & Transaction UI here.</p>
          </div>
        </div>
      </section>

      <section id="cash" v-if="page === 'cash'">
        <div class="content">
          <div class="card">
            <h2>Cash Management</h2>
            <p class="muted">Placeholder. Build your deposit/withdraw UI here.</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="content" style="padding-bottom:32px;">
      <p class="muted">© 2025 Stock App</p>
    </footer>
  </div>

  <script type="text/javascript">
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          menu: [
            { id: 'home', caption: 'Home' },
            { id: 'trade', caption: 'Trade' },
            { id: 'cash', caption: 'Cash' }
          ],
          page: 'login',

          // Auth/UI state
          authLoading: false,
          authError: '',

          // Simplified login uses email + password
          loginForm: { email: '', password: '' },

          // Simplified register uses fullName + email + password (+ confirm on UI only)
          regForm: { fullName: '', email: '', password: '', confirm: '' },

          // Optional profile display
          profileName: ''
        };
      },

      computed: {
        hasToken() {
          const t = localStorage.getItem('auth.token') || '';
          return !!t;
        }
      },

      methods: {
        changePage(next) {
          const protectedPages = ['home', 'trade', 'cash'];
          if (protectedPages.includes(next) && !this.hasToken) {
            this.page = 'login';
            return;
          }
          this.page = next;
          localStorage.setItem('lastPage', this.page);
        },

        goTo(id) {
          this.changePage(id);
        },

        async doLogin() {
          this.authError = '';

          if (!this.loginForm.email || !this.loginForm.password) {
            this.authError = 'Email and password are required.';
            return;
          }

          // very light email sanity (frontend only)
          const basicEmailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!basicEmailRx.test(this.loginForm.email)) {
            this.authError = 'Please enter a valid email address.';
            return;
          }

          this.authLoading = true;
          try {
            // Expect AuthAPI.login({ email, password }) to POST /api/users/login
            const r = await AuthAPI.login({
              email: this.loginForm.email,
              password: this.loginForm.password
            });
            this.authLoading = false;

            if (!r.ok || !r.token) {
              this.authError = (r.data && r.data.message) || 'Login failed';
              return;
            }

            const user = r?.data?.user || {};
            const displayName = user.fullName || user.username || this.loginForm.email;

            AuthAPI.storeAuth({
              token: r.token,
              email: this.loginForm.email,
              user
            });

            this.profileName = displayName;
            this.changePage('home');
          } catch (err) {
            this.authLoading = false;
            this.authError = err?.message || 'Login error';
          }
        },

        async doRegister() {
          this.authError = '';

          if (!this.regForm.fullName || !this.regForm.email || !this.regForm.password) {
            this.authError = 'Please fill all required fields.';
            return;
          }

          const basicEmailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!basicEmailRx.test(this.regForm.email)) {
            this.authError = 'Please enter a valid email address.';
            return;
          }

          if (this.regForm.password !== this.regForm.confirm) {
            this.authError = 'Passwords do not match.';
            return;
          }

          this.authLoading = true;
          try {
            // Expect AuthAPI.register({ fullName, email, password }) to POST /api/users/register
            const r = await AuthAPI.register({
              fullName: this.regForm.fullName,
              email: this.regForm.email,
              password: this.regForm.password
            });
            this.authLoading = false;

            if (!r.ok) {
              this.authError = (r.data && r.data.message) || 'Registration failed';
              return;
            }

            // After registration → go to Login and prefill email
            this.changePage('login');
            this.loginForm.email = this.regForm.email;
          } catch (err) {
            this.authLoading = false;
            this.authError = err?.message || 'Registration error';
          }
        },

        logout() {
          AuthAPI.clearAuth();
          this.profileName = '';
          this.changePage('login');
        }
      },

      mounted() {
        // Restore last page if already logged in
        const last = localStorage.getItem('lastPage') || 'home';
        const { token, user, email } = AuthAPI.loadAuth ? (AuthAPI.loadAuth() || {}) : {};
        if (token) {
          this.profileName = (user && (user.fullName || user.username)) || email || '';
          this.page = last;
        } else {
          this.page = 'login';
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
