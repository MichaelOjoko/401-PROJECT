  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MCM Stocks — Cash</title>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet" />
    <link rel="stylesheet" href="./main.css" />
    <script src="./main.js"></script>
    <style>
      .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      @media (max-width: 900px){ .grid-2 { grid-template-columns: 1fr; } }
      .label { font-weight:600; margin:8px 0 4px; }
      .balance {
        display:flex; align-items:center; justify-content:space-between;
        background: var(--card-bg, #fff); border:1px solid var(--gray); border-radius:12px;
        padding:14px 16px; margin-top:10px;
      }
      .balance .amt { font-size:22px; font-weight:700; }
    </style>
  </head>
  <body>
    <header>
      <div style="font-weight:700">MCM Stocks</div>
      <nav>
        <ul>
          <li><a href="index.html" data-top="index.html">Home</a></li>
          <li><a href="cash.html" data-top="cash.html" class="active">Wallet</a></li>
          <li id="nav-market"><a href="market.html" data-top="market.html">Market</a></li>
          <li id="nav-login"><a href="login.html" data-top="login.html">Login</a></li>
          <li id="nav-register"><a href="register.html" data-top="register.html">Register</a></li>
          <li id="nav-logout" style="display:none;"><a href="#" onclick="logoutUser()">Logout</a></li>
        </ul>
      </nav>
    </header>

    <main class="dashboard">
      <aside class="sidebar">
        <div class="group">
          <div class="group-title">Main</div>
          <ul>
            <li><a href="dashboard.html" data-route="index.html">Overview</a></li>
            <li><a href="portfolio.html" data-route="portfolio.html">Portfolio</a></li>
            <li><a href="market.html" data-route="market.html">Trading</a></li>
            <li><a href="cash.html" class="active" data-route="cash.html">Wallet</a></li>
          </ul>
        </div>
        <div class="group">
          <div class="group-title">Activity</div>
          <ul>
            <li><a href="tradehistory.html" data-route="tradehistory.html">Trade History</a></li>
            <li><a href="profile.html" data-route="profile.html">Profile</a></li>
            <li><a href="settings.html" data-route="settings.html">Settings</a></li>
          </ul>
        </div>
      </aside>

      <!-- content column -->
      <section class="content">
        <div class="card">
          <h1 style="margin:0;">Cash Management</h1>

          <!-- Live balance -->
          <div class="balance" id="balBox">
            <div>
              <div class="muted">Cash balance</div>
              <div class="amt" id="balAmt">$—</div>
            </div>
            <div class="muted" id="balCcy">USD</div>
          </div>

          <div class="grid-2" style="margin-top:12px;">
            <div class="card" style="margin:0;">
              <h3 style="margin-top:0;">Deposit</h3>
              <label class="label">Amount (USD)</label>
              <input type="number" id="dep_amt" step="0.01" min="0.01" placeholder="100.00" />
              <label class="label">From</label>
              <select id="dep_src">
                <option value="bank">Bank Account (**** 1234)</option>
                <option value="card">Debit Card (**** 5678)</option>
              </select>
              <button class="button positive" style="margin-top:12px;" id="btnDep">Deposit</button>
            </div>

            <div class="card" style="margin:0;">
              <h3 style="margin-top:0;">Withdraw</h3>
              <label class="label">Amount (USD)</label>
              <input type="number" id="wd_amt" step="0.01" min="0.01" placeholder="50.00" />
              <label class="label">To</label>
              <select id="wd_dst">
                <option value="bank">Bank Account (**** 1234)</option>
              </select>
              <button class="button positive" style="margin-top:12px;" id="btnWd">Withdraw</button>
            </div>
          </div>

          <p class="muted" id="cash-msg" style="margin-top:10px;"></p>
        </div>
      </section>
    </main>

    <footer class="content"><p class="muted">© 2025 MCM Stocks</p></footer>

    <script>
      // ===== Auth guard
      (function guard(){
        const { token } = (window.AuthAPI && AuthAPI.loadAuth()) || { token:'' };
        if (!token) location.replace('login.html');
      })();

      // ===== Helpers
      const $ = (s, el=document)=>el.querySelector(s);
      const fmt2 = (n)=>'$' + Number(n||0).toFixed(2);
      const setMsg = (t)=>{ $('#cash-msg').textContent = t || ''; };
      function getUserId(){
        try { const a = (window.AuthAPI && AuthAPI.loadAuth()) || {}; return a.id ? String(a.id) : null; }
        catch(_) { return null; }
      }

      async function authFetch(path, init){
        // Wrapper using your AuthAPI.fetch (adds bearer automatically)
        if (!window.AuthAPI || !AuthAPI.fetch) throw new Error('AuthAPI not available');
        return await AuthAPI.fetch(path, init);
      }

      // Try several balance endpoints (use whatever your backend exposes)
      async function fetchBalance(userId){
        const tryJson = async (url) => {
          try {
            const r = await authFetch(url, { method:'GET' });
            if (r.ok) return r.data;
          } catch(_) {}
          return null;
        };

        // 1) explicit balance
        let data = await tryJson(`/api/accounts/users/balance?userId=${encodeURIComponent(userId)}`);
        // 2) summary
        if (!data) data = await tryJson(`/api/accounts/users/summary?userId=${encodeURIComponent(userId)}`);
        // 3) me (account info embedded)
        if (!data) {
          const meRes = await authFetch('/api/users/me', { method:'GET' });
          if (meRes.ok) data = meRes.data?.account || meRes.data?.accounts?.[0] || null;
        }

        // Normalize common shapes
        if (!data) return { balance: null, currency: 'USD' };
        if (typeof data.balance === 'number') return { balance: data.balance, currency: data.currency || 'USD' };
        if (typeof data.cash_balance === 'number') return { balance: data.cash_balance, currency: data.currency || 'USD' };
        if (typeof data.available === 'number') return { balance: data.available, currency: data.currency || 'USD' };

        return { balance: null, currency: data.currency || 'USD' };
      }

      async function refreshBalance(){
        const uid = getUserId();
        if (!uid) return;
        const { balance, currency } = await fetchBalance(uid);
        $('#balAmt').textContent = (balance == null) ? '$—' : fmt2(balance);
        $('#balCcy').textContent = currency || 'USD';
      }

      // ===== Deposit / Withdraw actions
      async function doDeposit(){
        const uid = getUserId();
        if (!uid) return setMsg('Not authenticated.');
        const amount = Number($('#dep_amt').value || 0);
        const method = $('#dep_src').value || 'bank';
        if (!(amount > 0)) return setMsg('Enter a valid deposit amount.');

        setMsg('Submitting deposit…');
        try {
          const res = await authFetch('/api/accounts/users/deposit', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ userId: uid, amount, method })
          });

          if (!res.ok) {
            setMsg(res?.data?.message || 'Deposit failed.');
            return;
          }

          // Prefer updated balance in response if present; else refetch
          const newBal = res?.data?.balance ?? res?.data?.cash_balance ?? null;
          if (newBal != null) $('#balAmt').textContent = fmt2(newBal);
          else await refreshBalance();

          setMsg(`Deposit successful: ${fmt2(amount)} added.`);
          $('#dep_amt').value = '';
        } catch (err) {
          setMsg(err?.message || 'Deposit error.');
        }
      }

      async function doWithdraw(){
        const uid = getUserId();
        if (!uid) return setMsg('Not authenticated.');
        const amount = Number($('#wd_amt').value || 0);
        const method = $('#wd_dst').value || 'bank';
        if (!(amount > 0)) return setMsg('Enter a valid withdrawal amount.');

        setMsg('Submitting withdrawal…');
        try {
          const res = await authFetch('/api/accounts/users/withdraw', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ userId: uid, amount, method })
          });

          if (!res.ok) {
            setMsg(res?.data?.message || 'Withdrawal failed (insufficient funds?).');
            return;
          }

          const newBal = res?.data?.balance ?? res?.data?.cash_balance ?? null;
          if (newBal != null) $('#balAmt').textContent = fmt2(newBal);
          else await refreshBalance();

          setMsg(`Withdrawal successful: ${fmt2(amount)} sent.`);
          $('#wd_amt').value = '';
        } catch (err) {
          setMsg(err?.message || 'Withdrawal error.');
        }
      }

      // ===== Wire up
      document.getElementById('btnDep').addEventListener('click', doDeposit);
      document.getElementById('btnWd').addEventListener('click', doWithdraw);

      // ===== Init
      document.addEventListener('DOMContentLoaded', async () => {
        // header auth toggle
        const loggedIn = !!(window.AuthAPI && AuthAPI.isAuthenticated && AuthAPI.isAuthenticated());
        const logoutItem = document.getElementById("nav-logout");
        const loginItem  = document.getElementById("nav-login");
        const regItem    = document.getElementById("nav-register");
        if (loggedIn) { if (logoutItem) logoutItem.style.display='inline-block'; if (loginItem) loginItem.style.display='none'; if (regItem) regItem.style.display='none';
        } else { if (logoutItem) logoutItem.style.display='none'; if (loginItem) loginItem.style.display='inline-block'; if (regItem) regItem.style.display='inline-block'; }

        // load opening balance
        await refreshBalance();
      });

      // Highlight active links in sidebar/top
      (function highlight(){
        const p = location.pathname.split('/').pop() || 'cash.html';
        document.querySelectorAll('.sidebar a[data-route]').forEach(a =>
          a.classList.toggle('active', a.getAttribute('data-route') === p)
        );
        document.querySelectorAll('header nav a[data-top]').forEach(a =>
          a.classList.toggle('active', a.getAttribute('data-top') === p)
        );
      })();
    </script>
  </body>
  </html>
